{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Device Reservation</h2>
    <p>Welcome, {{ current_user.username }}!</p>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <form method="POST" action="{{ url_for('reservation.make_reservation') }}" id="reservationForm">
        <div class="form-group">
            <label for="device">Select Device:</label>
            <select class="form-control" id="device" name="device_id" required>
                {% for device in devices %}
                <option value="{{ device.device_id }}">{{ device.device_id }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="ip_type">Select IP Type:</label>
            <select class="form-control" id="ip_type" name="ip_type" required>
                <option value="rutomatrix">Rutomatrix (1 user max)</option>
                <option value="ctp1">CTP1 (3 users max)</option>
                <option value="ctp2">CTP2 (3 users max)</option>
                <option value="ctp3">CTP3 (3 users max)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="start_time">Start Time:</label>
            <input type="datetime-local" class="form-control" id="start_time" name="start_time" required
                   min="{{ now.strftime('%Y-%m-%dT%H:%M') }}">
        </div>
        
        <div class="form-group">
            <label for="end_time">End Time:</label>
            <input type="datetime-local" class="form-control" id="end_time" name="end_time" required
                   min="{{ now.strftime('%Y-%m-%dT%H:%M') }}">
        </div>
        
        <button type="submit" class="btn btn-primary">Reserve</button>
    </form>
    
    <h3 class="mt-4">Your Reservations</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Device</th>
                    <th>IP Type</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for res in user_reservations|sort(attribute='start_time') %}
                <tr>
                    <td>{{ res.device_id }}</td>
                    <td>{{ res.ip_type }}</td>
                    <td>{{ res.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ res.end_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if res.end_time < now %}
                            <span class="badge badge-secondary">Expired</span>
                        {% elif res.start_time <= now <= res.end_time %}
                            <span class="badge badge-success">Active</span>
                        {% else %}
                            <span class="badge badge-info">Upcoming</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if res.start_time > now %}
                            <form action="{{ url_for('reservation.cancel_reservation', reservation_id=res.id) }}" method="POST" class="cancel-form" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger cancel-btn">Cancel</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">No reservations found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h3 class="mt-4">Other Users' Reservations</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Device</th>
                    <th>IP Type</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Booked By</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for res in other_reservations|sort(attribute='start_time') %}
                <tr>
                    <td>{{ res.device_id }}</td>
                    <td>{{ res.ip_type }}</td>
                    <td>{{ res.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ res.end_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ res.user.user_name }}</td>
                    <td>
                        {% if res.end_time < now %}
                            <span class="badge badge-secondary">Expired</span>
                        {% elif res.start_time <= now <= res.end_time %}
                            <span class="badge badge-success">Active</span>
                        {% else %}
                            <span class="badge badge-info">Upcoming</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">No other reservations found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.getElementById('reservationForm');
    const startTime = document.getElementById('start_time');
    const endTime = document.getElementById('end_time');
    
    form.addEventListener('submit', function(e) {
        const start = new Date(startTime.value);
        const end = new Date(endTime.value);
        const now = new Date();
        
        if (end <= start) {
            alert('End time must be after start time');
            e.preventDefault();
            return false;
        }
        
        if (start < now) {
            alert('Start time cannot be in the past');
            e.preventDefault();
            return false;
        }
        
        return true;
    });
    
    // Set minimum end time when start time changes
    startTime.addEventListener('change', function() {
        endTime.min = startTime.value;
    });
    
    // Cancellation confirmation
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            if (!confirm('Are you sure you want to cancel this reservation?')) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}